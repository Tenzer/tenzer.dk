<!DOCTYPE html><html lang=en><head prefix="og: http://ogp.me/ns#"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Guide: Private Docker Registry - Tenzer.dk</title><meta name=description content="The personal website and blog for Jeppe Fihl-Pearson about open source technologies and photography."><meta name=generator content="Hugo 0.62.2"><style>body{background-color:#ecf0f1;color:#2c3e50;font-family:Georgia,serif;font-size:20px;line-height:1.6em;margin:0}a{color:#e74c3c;text-decoration:none}a h1{color:#2c3e50}hr{color:#8c97a1}header{background:#2c3e50;color:#ecf0f1;text-align:left}.header-container{margin:auto;max-width:700px;padding:10px}#logo{margin:10px 0;max-height:60px;max-width:100%}nav{display:-webkit-flex;display:flex;font-size:1rem;margin-bottom:20px;max-width:400px}nav a{color:#e74c3c}nav a,nav span{-webkit-flex:1;flex:1}nav span.disabled{color:#8c97a1}.container{background-image:linear-gradient(rgba(44,62,80,.4),rgba(44,62,80,0));background-image:-webkit-linear-gradient(top,rgba(44,62,80,.4),rgba(44,62,80,0));background-repeat:repeat-x;background-size:auto 20px;padding-top:20px}.content{margin:auto;max-width:700px;padding:0 10px}.content img{display:block;margin:auto;max-width:100%}.posted-date{color:#8c97a1;font-size:1rem;margin-top:0}h1{line-height:1;margin-bottom:.5rem}pre{border:1px dashed #cfd9db;line-height:1.25em;max-width:700px;overflow:auto;padding:5px 10px}pre code{background-color:inherit;border:none;padding:0}code{background-color:#f5f7f7;border:1px dashed #cfd9db;padding:5px}blockquote{border-left:3px solid #507192;color:#3e5871;font-style:italic;margin-left:20px;padding-left:10px}ul li{list-style-type:circle}.admonition-title{font-weight:700}.admonition{border:1px solid #2c3e50;border-radius:3px;margin:20px 0;padding:0 5px}.admonition p:first-child{margin-top:5px}.admonition p:last-child{margin-bottom:5px}.admonition.attention,.admonition.warning{background-color:#ffd34e}[data-expounder-c],[data-expounder]{text-decoration:none;border-bottom:1px dashed;cursor:pointer}@keyframes expoundedFadeIn{0%{opacity:0}to{opacity:1}}@keyframes expoundedFadeOut{0%{opacity:1}to{opacity:0}}[data-expounded]{display:none}[data-expounded].expounded-appear{display:initial;animation:expoundedFadeIn 1s}[data-expounded].expounded-disappear{display:initial;animation:expoundedFadeOut 1s}footer{font-size:15px;margin:auto;max-width:700px;text-align:center}@media print{footer,header{display:none}}</style><link rel=logo href=/static/favicon.3dada7eb0a.svg type=image/svg+xml><link rel=icon href=/static/favicon.3dada7eb0a.svg sizes=any type=image/svg+xml><link rel=icon href=/static/favicon.e5c65e608b.png sizes=128x128 type=image/png><link rel=icon href=/static/favicon.copy.a23706216d.ico sizes="16x16 32x32 48x48 64x64" type=image/x-icon><link rel=alternate href=https://tenzer.dk/index.xml type=application/rss+xml title=Tenzer.dk><meta name=theme-color content=#2C3E50><meta property=og:type content=website><meta property=og:url content=https://tenzer.dk/guide-private-docker-registry/ ><meta property=og:site_name content=Tenzer.dk><meta property=og:title content="Guide: Private Docker Registry - Tenzer.dk"><meta property=og:description content="I got to play around with Docker lately at work, and for that we needed a private place to store Docker images. Since the other guides I found either were unnecessarily advanced, or hosted the registry inside a Docker instance, instead of making use of our existing server setup, I've gone ahead and made a guide for how I set it up.
This guide shows the steps to take on an Ubuntu machine, but it should be easy to apply to other operating systems."><meta property=og:image content=https://tenzer.dk/images/logo.png><meta name=twitter:card content=summary><meta name=twitter:site content=@Tenzer><meta name=twitter:title content="Guide: Private Docker Registry - Tenzer.dk"><meta name=twitter:description content="I got to play around with Docker lately at work, and for that we needed a private place to store Docker images. Since the other guides I found either were unnecessarily advanced, or hosted the registry inside a Docker instance, instead of making use of our existing server setup, I've gone ahead and made a guide for how I set it up.
This guide shows the steps to take on an Ubuntu machine, but it should be easy to apply to other operating systems."><meta name=twitter:image content=https://tenzer.dk/images/logo.png></head><body><header><div class=header-container><a href=/ ><img id=logo src=/static/tenzerdk.90021cd24c.png alt="Tenzer.dk logo"></a></div></header><div class=container><div class=content><a href=/guide-private-docker-registry/ ><h1>Guide: Private Docker Registry</h1></a><p class=posted-date>Posted on January 14, 2015. Reading time: 4 minutes</p><p>I got to play around with <a href=https://www.docker.com/ >Docker</a> lately at work, and for that we needed a private place to store Docker images. Since the other guides I found either were unnecessarily advanced, or hosted the registry inside a Docker instance, instead of making use of our existing server setup, I've gone ahead and made a guide for how I set it up.</p><p>This guide shows the steps to take on an Ubuntu machine, but it should be easy to apply to other operating systems.</p><h2 id=installation>Installation</h2><p>We are going to use the official <a href=https://github.com/docker/docker-registry>Docker Registry</a> Python project for this, but first, lets create a user to run the registry as:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>sudo useradd --system --create-home docker</code></pre></div><p>We are going to install Docker Registry in a Python virtual environment, so lets install some packages for that:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>sudo apt-get install python-virtualenv libpython-dev liblzma-dev swig libssl-dev</code></pre></div><p>Then lets switch to the <code>docker</code> user to get it installed:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>sudo su - docker
virtualenv /home/docker/venv
/home/docker/venv/bin/pip install docker-registry</code></pre></div><h2 id=configuration>Configuration</h2><p>Next up we need to prepare a configuration file for Docker Registry. There's a sample configuration file included in the installed Python package, so lets use that as a base:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>cp /home/docker/venv/lib/python2.7/site-packages/config/config_sample.yml /home/docker/config.yml</code></pre></div><p>If you open the configuration file, you will see there are different sections of the configuration, where most of them inherit settings from one above. Each of those sections specify a configuration "set" or "flavor", and contains various settings regarding log levels, storage options and so on.</p><p>I won't go into detail about how to set up your configuration file, but I suggest that you create a new flavor at the end of the file, where you inherit the settings from the existing flavor, which is the closest match to what you would like.</p><p>When that's done and you have created any folders, AWS S3 buckets or whatever you may need according to your configuration, we need to get the Docker Registry started as a service.</p><h2 id=upstart>Upstart</h2><p>Upstart is probably the easiest way to set up a new service on Ubuntu so lets use that. Copy the following Upstart configuration to <code>/etc/init/docker-registry.conf</code>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>description "Docker Registry"

start on runlevel [2345]
stop on runlevel [!2345]
respawn

setuid docker
chdir /home/docker

env DOCKER_REGISTRY_CONFIG=/home/docker/config.yml
env SETTINGS_FLAVOR=custom
env PATH=/home/docker/venv/docker-registry/bin:$PATH

exec docker-registry</code></pre></div><p>You should change the <code>SETTINGS_FLAVOR</code> variable to the name of the flavor you created in the configuration file, and add any other environment variables you may need. Then you just need to start the service with:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>sudo start docker-registry</code></pre></div><p>Check the log file at <code>/var/log/upstart/docker-registry.log</code> and make sure it doesn't spit out a bunch of Python stack traces. If you have <code>curl</code> installed on the machine, you can also do a quick test by running <code>curl http://127.0.0.1:5000/</code> in order to make sure it responds with <code>"docker-registry server"</code>.</p><h2 id=nginx>Nginx</h2><p>Docker Registry does not provide any means of authentication or encryption for communication with clients, so you should put it behind an Nginx instance since it can provide that easily.</p><p>Install the Nginx version you prefer, here I go with <code>nginx-light</code> since it contains all we need. We also install <code>apache2-utils</code> since it contains the <code>htpasswd</code> utility we are going to use shortly:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>sudo apt-get install nginx-light apache2-utils</code></pre></div><p>Then replace the contents of <code>/etc/nginx/sites-available/default</code> with something like the following:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=color:#66d9ef>upstream</span> <span style=color:#e6db74>docker</span> { <span style=color:#f92672>server</span> 127.0.0.1:<span style=color:#ae81ff>5000</span>; }

<span style=color:#66d9ef>server</span> {
    <span style=color:#f92672>listen</span> <span style=color:#ae81ff>80</span>;
    <span style=color:#f92672>listen</span> <span style=color:#ae81ff>443</span> <span style=color:#e6db74>ssl</span>;

    <span style=color:#f92672>ssl_certificate</span> <span style=color:#e6db74>cert.pem</span>;
    <span style=color:#f92672>ssl_certificate_key</span> <span style=color:#e6db74>cert.key</span>;

    <span style=color:#f92672>client_max_body_size</span> <span style=color:#e6db74>500M</span>;
    <span style=color:#f92672>proxy_set_header</span> <span style=color:#e6db74>Host</span> $host;

    <span style=color:#f92672>auth_basic</span> <span style=color:#e6db74>"Docker</span> <span style=color:#e6db74>Registry"</span>;
    <span style=color:#f92672>auth_basic_user_file</span> <span style=color:#e6db74>/home/docker/auth</span>;

    <span style=color:#f92672>location</span> <span style=color:#e6db74>/</span> { <span style=color:#f92672>proxy_pass</span> <span style=color:#e6db74>http://docker</span>; }

    <span style=color:#75715e># Endpoints which are not requested with authentication
</span><span style=color:#75715e></span>    <span style=color:#f92672>location</span> <span style=color:#e6db74>/v1/_ping</span> { <span style=color:#f92672>proxy_pass</span> <span style=color:#e6db74>http://docker</span>; <span style=color:#f92672>auth_basic</span> <span style=color:#66d9ef>off</span>; }
    <span style=color:#f92672>location</span> <span style=color:#e6db74>/v1/search</span> { <span style=color:#f92672>proxy_pass</span> <span style=color:#e6db74>http://docker</span>; <span style=color:#f92672>auth_basic</span> <span style=color:#66d9ef>off</span>; }
}</code></pre></div><div class="admonition attention"><p class=admonition-title>Attention</p><p>Docker expects the registry to use HTTPS, but I won't go into how that is setup in Nginx as there are plenty of guides available on how to configure HTTPS already.</p></div><p>Reload the Nginx configuration, and then create a user in the auth file with <code>htpasswd</code>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>sudo service nginx reload
sudo htpasswd /home/docker/auth &lt;username&gt;</code></pre></div><p>You will be asked what password you would like the user to have, and then you should be all set. On your client machine you will first have to log into the registry with your newly created user with <code>docker login &lt;server URL&gt;</code> (it asks you for an e-mail address but it is not used for anything), and then you can search, push and pull from the Docker registry.</p><p>I hope you found this guide useful, and in case you have any comments to this guide or just want to get in touch with me, then find my on Twitter as <a href=https://twitter.com/Tenzer>@Tenzer</a>.</p><p><strong>Update!</strong><br>I've made <a href=/guide-docker-registry-frontend/ >another guide</a> on how to set up a frontend for your own registry, making it easier to navigate and manage.</p></div></div><footer>Copyright © 2020 <a href=https://twitter.com/Tenzer>Jeppe Fihl-Pearson</a> unless otherwise noted.</footer></body></html>